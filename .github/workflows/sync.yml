name: Sync Rule Files

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create downloads directory
        run: |
          mkdir -p public/downloads
          rm -rf public/downloads/*

      - name: Download latest release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd public/downloads
          gh release download latest --repo MetaCubeX/meta-rules-dat --pattern "*"

      - name: Generate files.json
        run: |
          cd public/downloads
          echo "{" > ../files.json
          echo "  \"updated_at\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"," >> ../files.json
          echo "  \"files\": [" >> ../files.json
          
          first=true
          for file in *; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> ../files.json
              fi
              echo -n "    {\"name\": \"$file\", \"size\": \"$size\"}" >> ../files.json
            fi
          done
          
          echo "" >> ../files.json
          echo "  ]" >> ../files.json
          echo "}" >> ../files.json

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        run: |
          git add public/downloads public/files.json
          git commit -m "Daily Sync - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || echo "No changes to commit"
          git push origin main

