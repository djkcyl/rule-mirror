name: Sync Rule Files

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create downloads directory
        run: |
          mkdir -p public/downloads/meta-rules-dat
          mkdir -p public/downloads/clash-rules
          rm -rf public/downloads/meta-rules-dat/*
          rm -rf public/downloads/clash-rules/*

      - name: Download MetaCubeX/meta-rules-dat assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd public/downloads/meta-rules-dat
          gh release download latest --repo MetaCubeX/meta-rules-dat --pattern "*"

      - name: Download Loyalsoldier/clash-rules assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd public/downloads/clash-rules
          # 获取最新的 release tag
          LATEST_TAG=$(gh release list --repo Loyalsoldier/clash-rules --limit 1 | awk '{print $1}')
          echo "Downloading release: $LATEST_TAG"
          gh release download "$LATEST_TAG" --repo Loyalsoldier/clash-rules --pattern "*.txt"

      - name: Generate files.json
        run: |
          echo "{" > public/files.json
          echo "  \"updated_at\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"," >> public/files.json
          echo "  \"projects\": [" >> public/files.json
          
          # MetaCubeX/meta-rules-dat
          echo "    {" >> public/files.json
          echo "      \"name\": \"MetaCubeX/meta-rules-dat\"," >> public/files.json
          echo "      \"description\": \"GeoIP / GeoSite 数据库\"," >> public/files.json
          echo "      \"path\": \"meta-rules-dat\"," >> public/files.json
          echo "      \"files\": [" >> public/files.json
          
          first=true
          cd public/downloads/meta-rules-dat
          for file in *; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> ../../files.json
              fi
              echo -n "        {\"name\": \"$file\", \"size\": \"$size\"}" >> ../../files.json
            fi
          done
          cd ../../..
          
          echo "" >> public/files.json
          echo "      ]" >> public/files.json
          echo "    }," >> public/files.json
          
          # Loyalsoldier/clash-rules
          echo "    {" >> public/files.json
          echo "      \"name\": \"Loyalsoldier/clash-rules\"," >> public/files.json
          echo "      \"description\": \"分流规则集（RULE-SET）\"," >> public/files.json
          echo "      \"path\": \"clash-rules\"," >> public/files.json
          echo "      \"files\": [" >> public/files.json
          
          first=true
          cd public/downloads/clash-rules
          for file in *; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> ../../files.json
              fi
              echo -n "        {\"name\": \"$file\", \"size\": \"$size\"}" >> ../../files.json
            fi
          done
          cd ../../..
          
          echo "" >> public/files.json
          echo "      ]" >> public/files.json
          echo "    }" >> public/files.json
          echo "  ]" >> public/files.json
          echo "}" >> public/files.json

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        run: |
          git add public/downloads/meta-rules-dat public/downloads/clash-rules public/files.json
          git commit -m "Daily Sync - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || echo "No changes to commit"
          git push origin main

