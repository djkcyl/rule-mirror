name: Sync Rule Files

on:
  schedule:
    # Run daily at 8 AM Beijing Time (0 AM UTC)
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clean and create downloads directory
        run: |
          rm -rf public/downloads
          mkdir -p public/downloads/meta-rules-dat
          mkdir -p public/downloads/clash-rules
          mkdir -p public/downloads/direct-android-ruleset
          mkdir -p public/downloads/metacubexd

      - name: Download MetaCubeX/meta-rules-dat assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd public/downloads/meta-rules-dat
          gh release download latest --repo djkcyl/meta-rules-dat --pattern "*"

      - name: Download Loyalsoldier/clash-rules assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd public/downloads/clash-rules
          # 获取最新的 release tag
          LATEST_TAG=$(gh release list --repo Loyalsoldier/clash-rules --limit 1 | awk '{print $3}')
          echo "Downloading release: $LATEST_TAG"
          gh release download "$LATEST_TAG" --repo Loyalsoldier/clash-rules --pattern "*.txt"

      - name: Download mnixry/direct-android-ruleset files
        run: |
          cd public/downloads/direct-android-ruleset
          # Download specific YAML files from rules branch
          curl -L -o APP.mutated.yaml "https://github.com/mnixry/direct-android-ruleset/raw/refs/heads/rules/@Merged/APP.mutated.yaml"
          curl -L -o GAME.mutated.yaml "https://github.com/mnixry/direct-android-ruleset/raw/refs/heads/rules/@Merged/GAME.mutated.yaml"

      - name: Download MetaCubeX/metacubexd gh-pages
        run: |
          cd public/downloads/metacubexd
          # Download gh-pages branch as ZIP
          curl -L -o metacubexd-gh-pages.zip "https://github.com/MetaCubeX/metacubexd/archive/refs/heads/gh-pages.zip"

      - name: Generate files.json
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "{" > public/files.json
          echo "  \"updated_at\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"," >> public/files.json
          echo "  \"projects\": [" >> public/files.json
          
          # MetaCubeX/meta-rules-dat
          echo "    {" >> public/files.json
          echo "      \"name\": \"MetaCubeX/meta-rules-dat\"," >> public/files.json
          echo "      \"description\": \"GeoIP / GeoSite Database\"," >> public/files.json
          
          # Get license from GitHub API
          license=$(gh api repos/MetaCubeX/meta-rules-dat --jq '.license.spdx_id // "Unknown"')
          echo "      \"license\": \"$license\"," >> public/files.json
          
          echo "      \"path\": \"meta-rules-dat\"," >> public/files.json
          
          # Calculate total size in bytes
          cd public/downloads/meta-rules-dat
          total_size=$(du -sb . | cut -f1)
          cd ../../..
          echo "      \"total_size\": $total_size," >> public/files.json
          
          echo "      \"files\": [" >> public/files.json
          
          first=true
          cd public/downloads/meta-rules-dat
          for file in *; do
            if [ -f "$file" ]; then
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> ../../files.json
              fi
              echo -n "        {\"name\": \"$file\", \"size\": $size}" >> ../../files.json
            fi
          done
          cd ../../..
          
          echo "" >> public/files.json
          echo "      ]" >> public/files.json
          echo "    }," >> public/files.json
          
          # Loyalsoldier/clash-rules
          echo "    {" >> public/files.json
          echo "      \"name\": \"Loyalsoldier/clash-rules\"," >> public/files.json
          echo "      \"description\": \"Rule Sets (RULE-SET)\"," >> public/files.json
          
          # Get license from GitHub API
          license=$(gh api repos/Loyalsoldier/clash-rules --jq '.license.spdx_id // "Unknown"')
          echo "      \"license\": \"$license\"," >> public/files.json
          
          echo "      \"path\": \"clash-rules\"," >> public/files.json
          
          # Calculate total size in bytes
          cd public/downloads/clash-rules
          total_size=$(du -sb . | cut -f1)
          cd ../../..
          echo "      \"total_size\": $total_size," >> public/files.json
          
          echo "      \"files\": [" >> public/files.json
          
          first=true
          cd public/downloads/clash-rules
          for file in *; do
            if [ -f "$file" ]; then
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> ../../files.json
              fi
              echo -n "        {\"name\": \"$file\", \"size\": $size}" >> ../../files.json
            fi
          done
          cd ../../..
          
          echo "" >> public/files.json
          echo "      ]" >> public/files.json
          echo "    }," >> public/files.json
          
          # mnixry/direct-android-ruleset
          echo "    {" >> public/files.json
          echo "      \"name\": \"mnixry/direct-android-ruleset\"," >> public/files.json
          echo "      \"description\": \"Android CN Apps & Games Direct Rule Sets\"," >> public/files.json
          
          # Get license from GitHub API
          license=$(gh api repos/mnixry/direct-android-ruleset --jq '.license.spdx_id // "Unknown"')
          echo "      \"license\": \"$license\"," >> public/files.json
          
          echo "      \"path\": \"direct-android-ruleset\"," >> public/files.json
          
          # Calculate total size in bytes
          cd public/downloads/direct-android-ruleset
          total_size=$(du -sb . | cut -f1)
          cd ../../..
          echo "      \"total_size\": $total_size," >> public/files.json
          
          echo "      \"files\": [" >> public/files.json
          
          first=true
          cd public/downloads/direct-android-ruleset
          for file in *; do
            if [ -f "$file" ]; then
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> ../../files.json
              fi
              echo -n "        {\"name\": \"$file\", \"size\": $size}" >> ../../files.json
            fi
          done
          cd ../../..
          
          echo "" >> public/files.json
          echo "      ]" >> public/files.json
          echo "    }," >> public/files.json
          
          # MetaCubeX/metacubexd
          echo "    {" >> public/files.json
          echo "      \"name\": \"MetaCubeX/metacubexd\"," >> public/files.json
          echo "      \"description\": \"Clash Meta Dashboard (Web UI)\"," >> public/files.json
          
          # Get license from GitHub API
          license=$(gh api repos/MetaCubeX/metacubexd --jq '.license.spdx_id // "Unknown"')
          echo "      \"license\": \"$license\"," >> public/files.json
          
          echo "      \"path\": \"metacubexd\"," >> public/files.json
          
          # Calculate total size in bytes
          cd public/downloads/metacubexd
          total_size=$(du -sb . | cut -f1)
          cd ../../..
          echo "      \"total_size\": $total_size," >> public/files.json
          
          echo "      \"files\": [" >> public/files.json
          
          first=true
          cd public/downloads/metacubexd
          for file in *; do
            if [ -f "$file" ]; then
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> ../../files.json
              fi
              echo -n "        {\"name\": \"$file\", \"size\": $size}" >> ../../files.json
            fi
          done
          cd ../../..
          
          echo "" >> public/files.json
          echo "      ]" >> public/files.json
          echo "    }" >> public/files.json
          echo "  ]" >> public/files.json
          echo "}" >> public/files.json

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        run: |
          git add public/downloads/meta-rules-dat public/downloads/clash-rules public/downloads/direct-android-ruleset public/downloads/metacubexd public/files.json
          git commit -m "Daily Sync - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || echo "No changes to commit"
          git push origin main
